# Розділ 18. Винятки

```{note}
Цей ШІ-переклад ще не відредаговано.
```

Виняток являє собою різновид виняткової ситуації; виникнення такої
ситуації (під час виконання програми) називається *Виникненням винятку
(Exception Occurrence*). Коли при виконанні певної конструкції виникає
виняток, решта виконання цієї конструкції *припиняється* і виконується
відповідний обробник винятків. Якщо конструкція не має обробника
винятків, то виняток поширюється. *Розповсюдження* винятку означає
його повторне виникнення у внутрішньому динамічно охоплюючому
контексті виконання \[AAR95, розділ 11-4\]. Якщо виняток не
згенеровано у тілі завдання, він не поширюється далі (оскільки немає
динамічно охоплюючого виконання). Якщо виняток стався під час
активації завдання, то активатор згенерує *помилку завдання* \[AAR95,
розділ 11-4\]. Існує попередньо визначена бібліотека, яка надає
додаткові можливості для винятків (Ada.Exceptions).

## Структури даних

### Виняток Id

Кожен окремий виняток представляється окремим значенням типу
*Exception Id*. Спеціальне значення *Null Id* не представляє жодного
виключення і є початковим значенням типу *Exception Id* за
замовчуванням. Кожне виникнення винятку представляється значенням типу
*Exception Occurrence*. Аналогічно, *Null Occurrence* не представляє
жодного винятку і є початковим значенням типу *Exception Occurrence*
за замовчуванням.

У середовищі виконання GNAT ідентифікатор винятку реалізовано як
доступ до запису (*Exception Data Ptr*). На рисунку 18.1 показано поля
цього запису. Поле *Not Handled By Others* використовується для того,
щоб відрізнити визначені користувачем винятки від внутрішніх винятків
часу виконання (наприклад, переривання завдання), які не можуть бути
оброблені визначеними користувачем обробниками винятків. Поле *Lang*
визначає мову, на якій оголошено виключення (за замовчуванням
\"Ada\"). Наступні два поля використовуються для зберігання повної
назви виключення. Це ім\'я складається з префікса (повний шлях до
області видимості, де оголошено виключення) та імені виключення.
Останнє поле використовується для створення зв\'язаних списків
ідентифікаторів винятків (описано у розділі 18.1.2).

![Запис ідентифікатора винятку](f18_1.png)

Рисунок 18.1: Запис ідентифікатора винятку

Коли виникає виняток, відповідний випадок винятку зберігається під час
виконання GNAT у полі *Compiler Data (Дані компілятора*) у ATCB. Тип
даних цього поля - запис; поле *Current Exception* цього запису
зберігає виникнення винятку.

Поле *Exception Raised* має значення *True*, щоб вказати, що виняток
дійсно було згенеровано. Коли виняток створюється вперше, це поле має
значення false; потім, коли він пізніше обробляється підпрограмою
GNARL *Raise Current Exception*, це поле має значення *True*. Це
дозволяє програмі розрізняти, чи має вона справу з повторним
здійманням винятку.

### Таблиця винятків

Через правила видимості винятків у мові Ада (виняток може бути
невидимим, хоча обробляється **іншим** обробником, повторно
викликається, а потім знову стає видимим для іншої області видимості)
необхідно використовувати глобальну таблицю *винятків* (*Exceptions
Table*). Для ефективної обробки винятків у середовищі виконання Ада
використовується хеш-таблиця (див. рисунок 18.3).

![Ідентифікатор події](f18_2.png)

Рисунок 18.2: Ідентифікатор події.

Як читач може бачити, використовується таблиця доступу до
ідентифікаторів винятків. Для обробки колізій використовується простий
зв\'язаний список ідентифікаторів винятків. Поле *HTable Ptr*
використовується для зв\'язування ідентифікаторів винятків.

Коли в задачі виникає виняток, необхідно знайти відповідний
ідентифікатор винятку. Тому обчислюється хеш-функція, і отриманий в
результаті зв\'язаний список обходить для пошуку ідентифікатора
винятку. Потім його посилання зберігається в ATCB задачі. Це посилання
зберігається в ATCB до тих пір, поки виняток не буде оброблено (хоча
виняток може бути невидимим у деяких обробниках винятків).

## Підпрограми часу виконання

### GNARL.Raise

Мова Ада дозволяє згенерувати виключення двома різними способами: (1)
за допомогою оператора **raise** і (2) за допомогою процедури
*Ada.Exceptions.Raise Exception*, яка дозволяє програмісту зв\'язати
повідомлення з виключенням. В обох випадках компілятор генерує виклик
функції GNARL, яка виконує наступні дії:

1.  Щоб заповнити виняток ATCB.

![Хеш-таблиця](f18_3.png)

Рисунок 18.3: Хеш-таблиця.

2.  Відкласти аборт.

3.  Якщо встановлено один обробник винятків, перейдіть до нього.

4.  В іншому випадку (без виклику обробника винятків) завершити
виконання програми.

## Підсумок

У цій главі представлено основні концепції реалізації обробки винятків
у GNAT. Ідентифікатор винятку - це доступ до запису, де зберігається
повна назва винятку. Виникнення винятку зберігається у ATCB. Всі
винятки зберігаються у хеш-таблиці.
